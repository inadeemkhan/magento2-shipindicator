<?php
declare(strict_types=1);

/**
 * Free Shipping Indicator Template
 *
 * @var \NadeemSoft\ShipIndicator\Block\Cart\Indicator $block
 */

/**
 * Do not render if:
 * - Module is disabled
 * - Quote is not initialized
 * - Cart is empty (homepage, CMS pages, etc.)
 */
if (!$block->canRender()) {
    return;
}

/* Render custom CSS from admin */
$customCss = trim($block->getCustomCSS());
if ($customCss !== '') {
    echo '<style>' . $customCss . '</style>';
}

/* Pre-calculate values safely */
$isEligible   = $block->isOrderEligibleForFreeShipping();
$progress     = min(100, max(0, $block->getFreeShippingCompletionRate()));
$minValue     = $block->getFreeShippingMinValue();
$remainingAmt = $block->getFreeShippingAmountDifference();
?>

<style>
:root {
    --freeship-bg-color: <?= /* @noEscape */ $block->getMessageBackground() ?>;
    --freeship-text-color: <?= /* @noEscape */ $block->getMessageTextColor() ?>;
    --freeship-font-size: <?= /* @noEscape */ $block->getFontSize() ?>px;
    --freeship-progress-color: <?= /* @noEscape */ $block->getProgressBarColor() ?>;
}
</style>

<div class="freeship-section">

    <?php if (!$isEligible): ?>

        <div class="freeship-indicator-wrapper">

            <!-- Minimum threshold -->
            <span class="min">
                <?= /* @noEscape */ $block->getFormattedPrice(0, 0) ?>
            </span>

            <!-- Progress bar -->
            <div class="freeship-indicator">
                <div class="freeship-indicator-bg">
                    <div class="freeship-indicator-fill freeship-indicator-progress"
                         style="width: <?= /* @noEscape */ $progress ?>%;">
                    </div>
                </div>
            </div>

            <!-- Maximum threshold -->
            <span class="max">
                <?= /* @noEscape */ $block->getFormattedPrice($minValue, 0) ?>
            </span>
        </div>

        <!-- Remaining amount message -->
        <?php if ($remainingAmt > 0): ?>
            <p class="message">
                <?= /* @noEscape */ __(
                    '%1 <span class="freeship-price">%2</span>',
                    $block->getTextMessage(),
                    $block->getFormattedPrice($remainingAmt)
                ) ?>
            </p>
        <?php endif; ?>

    <?php else: ?>

        <!-- Eligible message -->
        <div class="freeship-text">
            <p><?= /* @noEscape */ __($block->getEligibleTextMessage()) ?></p>
        </div>

    <?php endif; ?>

</div>
